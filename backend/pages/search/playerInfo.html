<div class="container p-4 playerNotAvailable text-center">
    <h2> Spieler nicht gefunden.</h2>
</div>


<div class="container p-4 playerAvailable">
    <div class="row d-flex justify-content-center">
        <div class="col-md-6 mt-4 col-xs-12">
            <div class="card bg-secondary" ID="testServer">
                <div class="card-body d-flex justify-content-center">
                    <div class="crone">
                        <img id="UserIcon" src="/assets/images/logo/crone.png">
                        <div class="centered IconYes"><a style="color:black;" href='/playerInfo?ID=' target='_blank'>Placeholder</a>
                        </div>
                    </div>
                </div>
                <div class="card-footer d-flex justify-content-center table-responsive">
                    <table id="normalPlayerData">
                        <tr id="NoIcon">
                            <th> Name</th>
                            <td></td>
                        </tr>
                        <tr>
                            <th> Rang</th>
                            <td></td>
                        </tr>

                        <tr>
                            <th> Stamm</th>
                            <td></td>
                        </tr>
                        <tr>
                            <th> Punkte</th>
                            <td></td>
                        </tr>
                        <tr>
                            <th> Dörfer</th>
                            <td></td>
                        </tr>
                        <tr>
                            <th> Eroberungen</th>
                            <td></td>
                        </tr>
                        <tr>
                            <th> Stammeswechsel</th>
                            <td></td>
                        </tr>
                        <tr>
                            <th> Intern</th>
                            <td></td>
                        </tr>
                        <tr>
                            <th> Babaadelungen</th>
                            <td></td>
                        </tr>
                        <tr>
                            <th> Max Dörfer</th>
                            <td></td>
                        </tr>
                        <tr>
                            <th> Max Punkte</th>
                            <td>
                        </tr>
                        <tr>
                            <th> Bester Rang</th>
                            <td></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-md-6 mt-4 col-xs-12 database">
            <div class="card bg-secondary">
                <div class="card-body d-flex justify-content-center">
                    <h5 class="card-title">
                        <img src="/assets/images/logo/Logo.png">
                    </h5>
                </div>
                <div class="card-footer d-flex justify-content-center table-responsive">
                    <table id="databasePlayerData">
                        <tr>
                            <th> Berichte</th>
                            <td></td>
                        </tr>
                        <tr>
                            <th> UT Berichte</th>
                            <td></td>
                        </tr>
                        <tr>
                            <th> Off-Dörfer</th>
                            <td></td>
                        </tr>
                        <tr>
                            <th> aktuell mögl. Offs</th>
                            <td></td>
                        </tr>
                        <tr>
                            <th> Deff-Dörfer</th>
                            <td></td>
                        </tr>
                        <tr>
                            <th> Wachtürme</th>
                            <td></td>
                        </tr>
                        <tr>
                            <th> Kirche</th>
                            <td></td>
                        </tr>
                        <tr>
                            <th> &#216; Off</th>
                            <td></td>
                        </tr>
                        <tr>
                            <th> &#216; Fake</th>
                            <td></td>
                        </tr>
                        <tr>
                            <th> &#216; Deff</th>
                            <td></td>
                        </tr>
                        <tr>
                            <th> &#216; Tab</th>
                            <td></td>
                        </tr>
                        <tr>
                            <th> Angriffe</th>
                            <td></td>
                        </tr>
                        <tr>
                            <th> Groß</th>
                            <td></td>
                        </tr>
                        <tr>
                            <th> Mittel</th>
                            <td></td>
                        </tr>
                        <tr>
                            <th> Klein</th>
                            <td></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-1 database lastSendTimes">
        </div>
        <div class="col-10 mt-3 database lastSendTimes">
            <div class="accordion accordion-flush" id="accordionFlushExample">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingOne">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#flush-collapseOne" aria-expanded="false"
                                aria-controls="flush-collapseOne">
                            Abschickzeiten
                        </button>
                    </h2>
                    <div id="flush-collapseOne" class="accordion-collapse collapse" aria-labelledby="flush-headingOne"
                         data-bs-parent="#accordionFlushExample">
                        <div id="lastSendTimes" class="accordion-body text-center">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-1 database lastSendTimes">
        </div>
    </div>
</div>

<div class="container p-4 playerAvailable">
    <div class="row">
        <div class="col-1">
        </div>
        <div class="col-md-10 col-xs-12 d-flex justify-content-center table-responsive">
            <table id="bashis">
                <thead style="border-bottom: 1px solid;">
                <tr>
                    <th> Art</th>
                    <th> Alle</th>
                    <th> Angreifer</th>
                    <th> Verteidiger</th>
                    <th> Unterstützer</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td> Rang </td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                <tr>
                <tr>
                    <td> Besiegte Gegner </td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                <tr>
                </tbody>
            </table>
        </div>
        <div class="col-1">
        </div>
        <div class="col-3">
        </div>
        <div class="col-md-6 col-xs-12 mt-4 d-flex justify-content-center">
            <div class="input-group input-group-sm mb-3 me-3">
                <label class="input-group-text" for="statsGeneral">Einträge pro Seite</label>
                <select id="statsGeneral" class="form-select">
                    <option value="points">Punkte</option>
                    <option value="rank">Rang</option>
                    <option value="village">Dörfer</option>
                </select>
            </div>
            <div class="input-group input-group-sm mb-3">
                <label class="input-group-text" for="statsBash">Einträge pro Seite</label>
                <select id="statsBash" class="form-select">
                    <option value="gesBash">Besiegte Gegner Insgesamt</option>
                    <option value="offBash">Besiegte Gegner als Angreifer</option>
                    <option value="defBash">Besiegte Gegner als Verteidiger</option>
                    <option value="supBash">Besiegte Gegner als Unterstützer</option>
                </select>
            </div>
        </div>
        <div class="col-3">
        </div>
        <div class="col-1">
        </div>
        <div class="col-lg-5 mt-4 col-md-12">
            <div id="points">
                Punkte
                <canvas id="pointDia"></canvas>
            </div>
            <div id="rank">
                Rang
                <canvas id="rankDia"></canvas>
            </div>
            <div id="village">
                Dörfer
                <canvas id="villageDia"></canvas>
            </div>
        </div>
        <div class="col-lg-5 mt-4 col-md-12">
            <div id="gesBash">
                Bashis Alle
                <canvas id="allBashDia"></canvas>
            </div>
            <div id="offBash">
                Bashis Angreifer
                <canvas id="attBashDia"></canvas>
            </div>
            <div id="defBash">
                Bashis Verteidiger
                <canvas id="defBashDia"></canvas>
            </div>
            <div id="supBash">
                Bashis Unterstützer
                <canvas id="supBashDia"></canvas>
            </div>
        </div>
        <div class="col-1">
        </div>
        <div class="col-1">
        </div>
        <div class="col-md-10 col-xs-12 mt-5 d-flex justify-content-center">
            <img id="userMap" src="/ajax/graphic/playerInfo.php" loading="lazy" class="img-fluid">
        </div>
        <div class="col-1">
        </div>
    </div>
</div>
<div class="placeholder">
    <br/>
</div>
<script type="text/javascript" src="/assets/js/mathHelpers.js"></script>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const playerID = urlParams.get('ID');
    if (playerID) {
        $(".playerNotAvailable").hide();
    } else {
        $(".playerAvailable").hide();
    }
</script>

<script>

    //is Player available?
    if (playerID) {
        let post = {
            id: playerID
        }
        $.ajax({
            url: "/ajax/general/playerAvailable.php",
            data: post,
            type: 'post',
            success: function (data) {
                let result = JSON.parse(data);
                if (!result) {
                    $(".playerAvailable").hide();
                    $(".playerNotAvailable").show();
                } else {
                    loadBasicPlayerData()
                }
            }
        });
    }

    //Loading all Basic PlayerInfos
    function loadBasicPlayerData() {
        let post = {
            id: playerID
        }

        $.ajax({
            url: "/ajax/player/getDiagramData.php",
            data: post,
            type: 'post',
            success: function (data) {
                let result = JSON.parse(data);
                createDiagram("allBashDia", result["allBashisDates"], "Insgesamt Bashis", result["allBashis"], "rgba(0,0,0,1)", "rgba(0,0,0,0.2)");
                createDiagram("attBashDia", result["attBashisDates"], "Angreifer Bashis", result["attBashis"], "rgba(0,0,0,1)", "rgba(0,0,0,0.2)");
                createDiagram("supBashDia", result["supBashisDates"], "Unterstützer Bashis", result["supBashis"], "rgba(0,0,0,1)", "rgba(0,0,0,0.2)");
                createDiagram("defBashDia", result["defBashisDates"], "Verteidiger Bashis", result["defBashis"], "rgba(0,0,0,1)", "rgba(0,0,0,0.2)");
                createDiagram("pointDia", result["pointsDates"], "Punkte", result["points"], "rgba(0,0,0,1)", "rgba(0,0,0,0.2)");
                createDiagramReverse("rankDia", result["rankDates"], "Rang", result["rank"], "rgba(0,0,0,1)", "rgba(0,0,0,0.2)");
                createDiagram("villageDia", result["villagesDates"], "Dörfer", result["villages"], "rgba(0,0,0,1)", "rgba(0,0,0,0.2)");
            }
        });
        $.ajax({
            url: "/ajax/player/getNormalPlayerData.php",
            data: post,
            type: 'post',
            success: function (data) {
                let result = JSON.parse(data);

                $("td", $('table#normalPlayerData')).eq(0).text(result["name"])
                $("td", $('table#normalPlayerData')).eq(1).text(result["rank"])
                let tribeURL = "<a href='tribeInfo?ID="+result["tribeTag"]+"'>"+result["tribeTag"]+"</a>";
                $("td", $('table#normalPlayerData')).eq(2).html(tribeURL)
                $("td", $('table#normalPlayerData')).eq(3).text(formatNumber(result["points"]))
                let villageURL = "<a href='allVillages?playerID="+result["name"]+"'>"+formatNumber(result["villages"])+"</a>";
                $("td", $('table#normalPlayerData')).eq(4).html(villageURL)
                let conquerURL = "<a href='conquers?playerName="+result["name"]+"'>"+formatNumber(result["conquersWin"] + result["conquersLoss"] + result["conquersSelf"])+"</a>";
                $("td", $('table#normalPlayerData')).eq(5).html(conquerURL)
                $("td", $('table#normalPlayerData')).eq(6).text(result["tribeChanges"])
                let conquerInternalURL = "<a href='conquers?playerName="+result["name"]+"&internal=ON'>"+formatNumber(result["conquersInternal"])+"</a>";
                $("td", $('table#normalPlayerData')).eq(7).html(conquerInternalURL)
                let conquerBarbarianURL = "<a href='conquers?playerName="+result["name"]+"&oldOwner=Barbaren'>"+formatNumber(result["conquersBarbarian"])+"</a>";
                $("td", $('table#normalPlayerData')).eq(8).html(formatNumber(conquerBarbarianURL))
                $("td", $('table#normalPlayerData')).eq(9).text(formatNumber(result["maxVillages"]) + " (" + result["maxVillagesDate"] + ")")
                $("td", $('table#normalPlayerData')).eq(10).text(formatNumber(result["maxPoints"]) + " (" + result["maxPointsDate"] + ")")
                $("td", $('table#normalPlayerData')).eq(11).text(result["maxRank"] + " (" + result["maxRankDate"] + ")")
                $("table#bashis tr :eq(6)").text(result["allRank"])
                $("table#bashis tr :eq(7)").text(result["attRank"])
                $("table#bashis tr :eq(8)").text(result["defRank"])
                $("table#bashis tr :eq(9)").text(result["supRank"])
                $("table#bashis tr :eq(11)").text(formatNumber(result["allBashis"]))
                $("table#bashis tr :eq(12)").text(formatNumber(result["attBashis"]))
                $("table#bashis tr :eq(13)").text(formatNumber(result["defBashis"]))
                $("table#bashis tr :eq(14)").text(formatNumber(result["supBashis"]))
                loadPicture(result["name"])
                let UserMap = "/ajax/graphic/playerInfo.php?id=" + result["ID"];
                $("#userMap").attr("src", UserMap);
                loadDatabaseData();
            }
        });

        function loadPicture(name) {
            $.ajax({
                url: "/ajax/inno/guestPage.php",
                data: post,
                type: 'post',
                success: function (data) {
                    if ($("img", $(".vis", $(data)).eq(3)).length > 0) {
                        let src = $("img", $(".vis", $(data)).eq(3)).attr("src");
                        $("#UserIcon").attr("src", src);
                        $(".centered.IconYes").hide();
                    } else {
                        $(".centered.IconYes a").text(name)
                        $(".centered.IconYes a").attr("href", "/playerInfo?ID=" + name)
                        $("#NoIcon").hide();
                    }
                }
            });
        }

        function loadDatabaseData() {
            $.ajax({
                url: "/ajax/player/getPlayerDatabaseData.php",
                data: post,
                type: 'post',
                success: function (data) {
                    let result = JSON.parse(data);
                    if(!result){
                        $(".database").hide()
                    }else{
                        let reportURL = `<a href='/showReports?playerName=${result["PlayerData"]["name"]}'>${formatNumber(result["PlayerData"]["quantityReports"])}</a>`;
                        $("td",$('table#databasePlayerData')).eq(0).html(reportURL);

                        let supReportURL = `<a href='/showUTReports?playerName=${result["PlayerData"]["name"]}'>${formatNumber(result["PlayerData"]["quantitySupReports"])}</a>`;
                        $("td",$('table#databasePlayerData')).eq(1).html(supReportURL);

                        let offensiveVillageURL = `<a href='/showReports?playerName=${result["PlayerData"]["name"]}&coordType=Off'>${formatNumber(result["PlayerData"]["offensiveVillages"])}</a>`;
                        $("td",$('table#databasePlayerData')).eq(2).html(offensiveVillageURL);

                        $("td",$('table#databasePlayerData')).eq(3).text(formatNumber(result["possibleOffensiveVillages"]))

                        let defensiveVillageURL = `<a href='/showReports?playerName=${result["PlayerData"]["name"]}&coordType=Def'>${formatNumber(result["PlayerData"]["defensiveVillages"])}</a>`;
                        $("td",$('table#databasePlayerData')).eq(4).html(defensiveVillageURL);

                        let watchtowerURL = `<a href='/showReports?playerName=${result["PlayerData"]["name"]}&watchtower=ON'>${formatNumber(result["PlayerData"]["watchtowers"])}</a>`;
                        $("td",$('table#databasePlayerData')).eq(5).html(watchtowerURL)

                        let churchesURL = `<a href='/showReports?playerName=${result["PlayerData"]["name"]}&church=ON'>${formatNumber(result["PlayerData"]["churches"])}</a>`;
                        $("td",$('table#databasePlayerData')).eq(6).html(churchesURL)
                        $("td",$('table#databasePlayerData')).eq(7).text(result["PlayerData"]["averageOff"])
                        $("td",$('table#databasePlayerData')).eq(8).text(result["PlayerData"]["averageFake"])
                        $("td",$('table#databasePlayerData')).eq(9).text(result["PlayerData"]["averageDef"])
                        $("td",$('table#databasePlayerData')).eq(10).text(result["PlayerData"]["averageTab"])
                        $("td",$('table#databasePlayerData')).eq(11).text(formatNumber(result["attackSizes"]["large"]+result["attackSizes"]["middle"]+result["attackSizes"]["small"]+result["attackSizes"]["fake"]))
                        $("td",$('table#databasePlayerData')).eq(12).text(formatNumber(result["attackSizes"]["large"]))
                        $("td",$('table#databasePlayerData')).eq(13).text(formatNumber(result["attackSizes"]["middle"]))
                        $("td",$('table#databasePlayerData')).eq(14).text(formatNumber(result["attackSizes"]["small"]+result["attackSizes"]["fake"]))
                        $(".card").eq(1).css("height",$(".card").eq(0).height())
                        if(result["lastSendTimes"].length){
                            result["lastSendTimes"].forEach(element => {
                                let row = `${element[0]} Uhr ${element[1]} <br>`;
                                $("#lastSendTimes").append(row);
                            })
                        }else{
                            $(".lastSendTimes").hide();
                        }
                    }
                }
            });
        }

    }
</script>


<script>
    //Diagram stuff
    $(document).ready(function () {
        $("#points").css('display', 'visible');
        $("#rank").css('display', 'none');
        $("#village").css('display', 'none');
        $("#gesBash").css('display', 'block');
        $("#offBash").css('display', 'none');
        $("#defBash").css('display', 'none');
        $("#supBash").css('display', 'none');
    });

    $("#statsGeneral").change(function () {
        let option1 = $("#statsGeneral").val();
        if (option1 === 'points') {
            $("#points").css('display', 'block');
            $("#rank").css('display', 'none');
            $("#village").css('display', 'none');
        }
        if (option1 === 'rank') {
            $("#points").css('display', 'none');
            $("#rank").css('display', 'block');
            $("#village").css('display', 'none');
        }
        if (option1 === 'village') {
            $("#points").css('display', 'none');
            $("#rank").css('display', 'none');
            $("#village").css('display', 'block');
        }
    });

    $("#statsBash").change(function () {
        let option1 = $("#statsBash").val();
        if (option1 === 'gesBash') {
            $("#gesBash").css('display', 'block');
            $("#offBash").css('display', 'none');
            $("#defBash").css('display', 'none');
            $("#supBash").css('display', 'none');
        }
        if (option1 === 'offBash') {
            $("#gesBash").css('display', 'none');
            $("#offBash").css('display', 'block');
            $("#defBash").css('display', 'none');
            $("#supBash").css('display', 'none');
        }
        if (option1 === 'defBash') {
            $("#gesBash").css('display', 'none');
            $("#offBash").css('display', 'none');
            $("#defBash").css('display', 'block');
            $("#supBash").css('display', 'none');
        }
        if (option1 === 'supBash') {
            $("#gesBash").css('display', 'none');
            $("#offBash").css('display', 'none');
            $("#defBash").css('display', 'none');
            $("#supBash").css('display', 'block');
        }
    });

    function createDiagram(id, labels, label, data, color, bgColor) {
        new Chart(document.getElementById(id).getContext('2d'), {
            type: 'line',
            responsive: true,
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    fill: true,
                    borderColor: color,
                    data: data,
                    backgroundColor: bgColor
                }]
            }
        });
    }

    function createDiagramReverse(id, labels, label, data, color, bgColor) {
        new Chart(document.getElementById(id).getContext('2d'), {
            type: 'line',
            responsive: true,
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    fill: true,
                    borderColor: color,
                    data: data,
                    backgroundColor: bgColor
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        reverse: true
                    }
                }
            }
        });
    }
</script>